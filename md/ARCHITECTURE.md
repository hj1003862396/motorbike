# æŠ€æœ¯æ¶æ„æ–‡æ¡£

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¾“å…¥è§†é¢‘ (a.mp4)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   è§†é¢‘å¸§è¯»å– (OpenCV)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ©ç åº”ç”¨ (å¯é€‰)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚
        â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YOLOv4 æ£€æµ‹     â”‚      â”‚  Deep Sort è·Ÿè¸ª  â”‚
â”‚  (ObjectDetection)      â”‚  (Deep Sort)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ç½‘æ ¼ç³»ç»Ÿ (Grid)          â”‚
        â”‚   - 99 ä¸ªç½‘æ ¼å•å…ƒ          â”‚
        â”‚   - é€Ÿåº¦è®¡ç®—               â”‚
        â”‚   - æ•°æ®æ”¶é›†               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ç»“æœå¯è§†åŒ–               â”‚
        â”‚   - æ£€æµ‹æ¡†                 â”‚
        â”‚   - è·Ÿè¸ª ID                â”‚
        â”‚   - ç½‘æ ¼çº¿                 â”‚
        â”‚   - ç»Ÿè®¡ä¿¡æ¯               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   è¾“å‡ºè§†é¢‘ (MP4)           â”‚
        â”‚   output_detection.mp4     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ¨¡å—è¯´æ˜

### 1. ObjectDetection æ¨¡å—

**æ–‡ä»¶ï¼š** `object_detection.py`

**åŠŸèƒ½ï¼š** ä½¿ç”¨ YOLOv4 è¿›è¡Œå¯¹è±¡æ£€æµ‹

**ä¸»è¦æ–¹æ³•ï¼š**

```python
class ObjectDetection:
    def __init__(self, weights_path, config_path)
        # åˆå§‹åŒ–æ£€æµ‹å™¨

    def load_class_names(self, class_names_path)
        # åŠ è½½ç±»åˆ«åç§°

    def load_detection_model(self, image_size, nmsThreshold, confThreshold)
        # åŠ è½½æ¨¡å‹

    def detect(self, frame)
        # æ£€æµ‹å¯¹è±¡
        # è¿”å›: (class_ids, scores, boxes)
```

**å·¥ä½œæµç¨‹ï¼š**
1. è¯»å–å›¾åƒ
2. è½¬æ¢ä¸º blob
3. å‰å‘ä¼ æ’­
4. åº”ç”¨ NMSï¼ˆéæœ€å¤§å€¼æŠ‘åˆ¶ï¼‰
5. è¿”å›æ£€æµ‹ç»“æœ

### 2. Deep Sort è·Ÿè¸ªæ¨¡å—

**æ–‡ä»¶ï¼š** `deep_sort_wrapper.py`

**åŠŸèƒ½ï¼š** ä½¿ç”¨ Deep Sort è¿›è¡Œå¤šç›®æ ‡è·Ÿè¸ª

**ä¸»è¦ç±»ï¼š**

```python
class Deep:
    def __init__(self, max_distance, nms_max_overlap, n_init, max_age, max_iou_distance)
        # åˆå§‹åŒ–è·Ÿè¸ªå™¨

    def sort_tracker(self)
        # åˆ›å»ºè·Ÿè¸ªå™¨

    def encoder(self, frame, boxes)
        # æå–ç‰¹å¾

    def Detection(self, boxes, scores, class_ids, features)
        # åˆ›å»ºæ£€æµ‹å¯¹è±¡
```

**å·¥ä½œæµç¨‹ï¼š**
1. é¢„æµ‹è½¨è¿¹
2. åŒ¹é…æ£€æµ‹å’Œè½¨è¿¹
3. æ›´æ–°è½¨è¿¹
4. è¿”å›è·Ÿè¸ªç»“æœ

### 3. ç½‘æ ¼ç³»ç»Ÿæ¨¡å—

**æ–‡ä»¶ï¼š** `grid.py`

**åŠŸèƒ½ï¼š** ç®¡ç†ç½‘æ ¼å•å…ƒå’Œæ•°æ®æ”¶é›†

**ä¸»è¦ç±»ï¼š**

```python
class RectangularArea:
    def __init__(self, row, col, x1, y1, x2, y2)
        # åˆ›å»ºç½‘æ ¼å•å…ƒ

    def contains(self, x, y)
        # æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨ç½‘æ ¼å†…

    def add_object(self, object_id, frame_count, timestamp, position)
        # æ·»åŠ å¯¹è±¡

    def calculate_instant_speed(self, object_id, grids, root_grids)
        # è®¡ç®—ç¬æ—¶é€Ÿåº¦

    def calculate_spatial_speed(self, object_id, root_grids, grids)
        # è®¡ç®—ç©ºé—´é€Ÿåº¦
```

## ğŸ”„ æ•°æ®æµ

### å•å¸§å¤„ç†æµç¨‹

```
Frame Input
    â”‚
    â”œâ”€â†’ æ©ç åº”ç”¨
    â”‚
    â”œâ”€â†’ YOLOv4 æ£€æµ‹
    â”‚   â””â”€â†’ è¾“å‡º: boxes, scores, class_ids
    â”‚
    â”œâ”€â†’ ç‰¹å¾æå–
    â”‚   â””â”€â†’ è¾“å‡º: features (128-dim vectors)
    â”‚
    â”œâ”€â†’ æ£€æµ‹å¯¹è±¡åˆ›å»º
    â”‚   â””â”€â†’ è¾“å‡º: Detection objects
    â”‚
    â”œâ”€â†’ Deep Sort é¢„æµ‹
    â”‚   â””â”€â†’ é¢„æµ‹è½¨è¿¹ä½ç½®
    â”‚
    â”œâ”€â†’ Deep Sort æ›´æ–°
    â”‚   â””â”€â†’ è¾“å‡º: tracked_ids, tracked_boxes
    â”‚
    â”œâ”€â†’ ç½‘æ ¼æ£€æŸ¥
    â”‚   â””â”€â†’ åˆ†é…åˆ°ç½‘æ ¼å•å…ƒ
    â”‚
    â”œâ”€â†’ é€Ÿåº¦è®¡ç®—
    â”‚   â””â”€â†’ è®¡ç®—ç¬æ—¶å’Œç©ºé—´é€Ÿåº¦
    â”‚
    â””â”€â†’ å¯è§†åŒ–
        â””â”€â†’ ç»˜åˆ¶æ¡†ã€IDã€ç½‘æ ¼
```

## ğŸ¯ å…³é”®å‚æ•°

### YOLOv4 å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | èŒƒå›´ | è¯´æ˜ |
|------|--------|------|------|
| image_size | 416 | 416-1280 | è¾“å…¥å›¾åƒå¤§å° |
| confThreshold | 0.3 | 0-1 | ç½®ä¿¡åº¦é˜ˆå€¼ |
| nmsThreshold | 0.4 | 0-1 | NMS é˜ˆå€¼ |

### Deep Sort å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| max_distance | 0.7 | æœ€å¤§åŒ¹é…è·ç¦» |
| n_init | 3 | åˆå§‹åŒ–å¸§æ•° |
| max_age | 15 | æœ€å¤§å¹´é¾„ |
| max_iou_distance | 0.7 | IOU è·ç¦»é˜ˆå€¼ |

### ç½‘æ ¼å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| n_rows | 11 | ç½‘æ ¼è¡Œæ•° |
| n_cols | 9 | ç½‘æ ¼åˆ—æ•° |
| cell_width | 40 | å•å…ƒå®½åº¦ |
| cell_height | 30 | å•å…ƒé«˜åº¦ |

## ğŸ“Š æ•°æ®ç»“æ„

### æ£€æµ‹ç»“æœ

```python
class_ids: List[int]      # ç±»åˆ« ID
scores: List[float]       # ç½®ä¿¡åº¦åˆ†æ•°
boxes: List[List[int]]    # è¾¹ç•Œæ¡† [x, y, w, h]
```

### è·Ÿè¸ªç»“æœ

```python
class_ids: List[int]      # ç±»åˆ« ID
object_ids: List[int]     # è·Ÿè¸ª ID
boxes: List[List[int]]    # è¾¹ç•Œæ¡† [x1, y1, x2, y2]
```

### ç½‘æ ¼æ•°æ®

```python
grids: Dict[str, RectangularArea]
# é”®: "grid_r_c" (ä¾‹å¦‚ "grid_0_0")
# å€¼: RectangularArea å¯¹è±¡
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. å›¾åƒå¤§å°ä¼˜åŒ–

```python
# æ›´å¿«ä½†å‡†ç¡®åº¦ä½
image_size = 416

# æ›´å‡†ç¡®ä½†æ›´æ…¢
image_size = 832
```

### 2. é˜ˆå€¼ä¼˜åŒ–

```python
# æ£€æµ‹æ›´å¤šå¯¹è±¡
confThreshold = 0.2

# æ£€æµ‹æ›´å°‘å¯¹è±¡
confThreshold = 0.5
```

### 3. è·Ÿè¸ªä¼˜åŒ–

```python
# æ›´ä¸¥æ ¼çš„è·Ÿè¸ª
max_distance = 0.5

# æ›´å®½æ¾çš„è·Ÿè¸ª
max_distance = 0.9
```

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æ‰“å°è°ƒè¯•ä¿¡æ¯

```python
print(f"Detections: {len(boxes)}")
print(f"Tracked IDs: {len(object_ids)}")
print(f"Frame: {frame_idx}/{total_frames}")
```

### 2. ä¿å­˜ä¸­é—´ç»“æœ

```python
cv2.imwrite(f"frame_{frame_idx}.jpg", frame)
cv2.imwrite(f"detection_{frame_idx}.jpg", output_frame)
```

### 3. æ€§èƒ½åˆ†æ

```python
import time
start = time.time()
# ä»£ç 
end = time.time()
print(f"Time: {end - start:.2f}s")
```

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ é€Ÿåº¦æ˜¾ç¤º

åœ¨ `save_output_video.py` ä¸­æ·»åŠ ï¼š

```python
# è®¡ç®—é€Ÿåº¦
speed = calculate_speed(prev_pos, curr_pos, fps)
cv2.putText(output_frame, f"Speed: {speed:.1f} km/h",
            (x, y+40), cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)
```

### 2. æ·»åŠ è½¨è¿¹ç»˜åˆ¶

```python
# ç»˜åˆ¶è½¨è¿¹çº¿
for i in range(len(trajectory)-1):
    cv2.line(output_frame, trajectory[i], trajectory[i+1], color, 2)
```

### 3. æ·»åŠ æ•°æ®å¯¼å‡º

```python
# å¯¼å‡ºä¸º CSV
import csv
with open('results.csv', 'w') as f:
    writer = csv.writer(f)
    writer.writerow(['frame', 'id', 'x', 'y', 'speed'])
    # å†™å…¥æ•°æ®
```

## ğŸ”— æ¨¡å—ä¾èµ–å…³ç³»

```
save_output_video.py
â”œâ”€â”€ object_detection.py
â”‚   â””â”€â”€ cv2 (OpenCV)
â”œâ”€â”€ deep_sort_wrapper.py
â”‚   â”œâ”€â”€ deep_sort/
â”‚   â”‚   â”œâ”€â”€ tracker.py
â”‚   â”‚   â”œâ”€â”€ detection.py
â”‚   â”‚   â””â”€â”€ nn_matching.py
â”‚   â””â”€â”€ numpy
â”œâ”€â”€ grid.py
â”‚   â””â”€â”€ numpy
â””â”€â”€ cv2 (OpenCV)
```

## ğŸ“ å­¦ä¹ èµ„æº

### YOLOv4
- [YOLOv4 è®ºæ–‡](https://arxiv.org/abs/2004.10934)
- [Darknet GitHub](https://github.com/AlexeyAB/darknet)

### Deep Sort
- [Deep Sort è®ºæ–‡](https://arxiv.org/abs/1703.07402)
- [Deep Sort GitHub](https://github.com/nwojke/deep_sort)

### OpenCV
- [OpenCV æ–‡æ¡£](https://docs.opencv.org/)
- [OpenCV æ•™ç¨‹](https://docs.opencv.org/master/d9/df8/tutorial_root.html)

---

**æœ€åæ›´æ–°ï¼š** 2026-01-30
